<!-- index.html COM AUTENTICAÇÃO -->
<!DOCTYPE html>
<html>
<body>
<div id="auth">
    <h3>AUTENTICAÇÃO</h3>
    <input id="room" placeholder="Room Code">
    <input id="user" placeholder="User" value="mago">
    <input id="senha" placeholder="Senha" type="password">
    <button onclick="conectar()">Conectar</button>
</div>

<canvas id="tela" style="display:none;"></canvas>

<script>
let ws = null;

function conectar() {
    const room = document.getElementById('room').value;
    const user = document.getElementById('user').value;
    const senha = document.getElementById('senha').value;
    
    if (!room || !user || !senha) {
        alert("Preencha todos os campos!");
        return;
    }
    
    // Tenta pegar room da URL primeiro
    const urlParams = new URLSearchParams(window.location.search);
    const urlRoom = urlParams.get('room');
    const urlCreds = urlParams.get('credenciais');
    
    // Se veio da URL, usa esses dados
    const finalRoom = urlRoom || room;
    let finalUser = user;
    let finalSenha = senha;
    
    if (urlCreds) {
        // Parse credenciais da URL: "user:mago,senha:123"
        const parts = urlCreds.split(',');
        parts.forEach(part => {
            const [key, value] = part.split(':');
            if (key === 'user') finalUser = value;
            if (key === 'senha') finalSenha = value;
        });
    }
    
    // Conecta ao servidor
    ws = new WebSocket('ws://localhost:8765');
    
    ws.onopen = () => {
        // Envia autenticação
        ws.send(JSON.stringify({
            tipo: 'viewer',
            room: finalRoom,
            user: finalUser,
            senha: finalSenha
        }));
        
        document.getElementById('auth').style.display = 'none';
        document.getElementById('tela').style.display = 'block';
        console.log("Autenticado!");
    };
    
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.type === 'frame') {
            const canvas = document.getElementById('tela');
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            img.onload = () => {
                canvas.width = data.width;
                canvas.height = data.height;
                ctx.drawImage(img, 0, 0);
            };
            img.src = 'data:image/jpeg;base64,' + data.data;
        }
    };
    
    ws.onerror = () => {
        alert("Erro de conexão!");
    };
}
</script>
</body>
</html>
